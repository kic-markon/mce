
(defparameter logo0 
#(71 73 70 56 57 97 74 3 83 2 245 0 0 0 0 0 150 118 181 151 120 182 153 122 183 156 125 185 158 129 187 161 133 189 163 
136 191 166 139 193 169 143 195 172 147 197 175 152 199 175 151 200 175 152 200 178 155 202 182 161 205 184 164 207 186 
166 208 189 170 210 192 174 213 195 177 214 198 181 217 199 184 218 202 188 220 206 193 223 208 194 223 207 195 224 209 
197 225 212 202 227 216 207 230 218 208 231 220 211 233 223 216 235 224 215 234 227 220 237 231 225 239 232 225 239 231 
225 240 234 228 241 238 234 244 241 238 246 243 240 247 245 243 249 248 246 251 254 254 255 0 0 0 0 0 0 0 0 0 0 0 0 0 0 
0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 33 249 4 1 0 0 0 0 44 0 0 0 0 74 3 
83 2 0 6 254 64 128 112 72 44 26 143 200 164 114 201 108 58 159 208 168 116 74 173 90 175 216 172 118 203 237 122 191 224 
176 120 76 46 155 207 232 180 122 205 110 187 223 240 184 124 78 175 219 239 248 188 126 207 239 251 255 128 129 130 131 
132 133 134 135 136 137 138 139 140 141 142 143 144 145 146 147 148 149 150 151 152 153 154 155 156 157 158 159 160 161 
162 163 164 165 166 167 168 169 170 171 172 173 174 175 176 177 178 179 180 181 182 183 184 185 186 187 188 189 190 191 
192 193 194 195 196 197 198 199 200 201 202 203 204 205 206 207 208 209 210 211 212 213 214 215 216 217 218 219 220 221 
222 223 224 225 226 227 228 229 230 231 232 233 234 235 236 237 238 239 240 241 242 243 244 245 246 247 248 249 250 251 
252 253 254 255 0 3 10 28 72 176 160 193 131 8 19 42 92 200 176 161 195 135 16 35 74 156 72 177 162 197 139 24 51 106 220 
200 177 163 199 143 32 67 138 28 73 178 164 201 147 40 83 170 92 201 178 165 203 151 48 99 202 156 73 179 166 205 155 56 
115 234 220 201 179 167 254 207 159 64 131 10 29 74 180 168 209 163 72 147 42 93 202 180 169 211 167 80 163 74 157 74 181 
170 213 171 88 179 106 221 202 181 171 215 175 96 195 138 29 75 182 172 217 179 104 211 170 93 203 182 173 219 183 112 227 
202 157 75 183 174 221 187 120 243 234 221 203 183 175 223 191 128 3 11 30 76 184 176 225 195 136 19 43 94 204 184 177 227 
199 144 35 75 158 76 185 178 229 203 152 51 107 222 204 185 179 231 207 160 67 139 30 77 186 180 233 211 168 83 171 94 205 
186 181 235 215 176 99 203 158 77 187 182 237 219 184 115 235 222 205 187 183 239 223 192 131 11 31 78 188 184 241 227 200 
147 43 95 206 188 185 243 231 208 163 75 159 78 189 186 245 235 216 179 107 223 206 189 187 247 239 224 195 139 31 79 190 
188 249 243 232 211 171 95 207 190 189 251 247 240 227 203 159 79 191 190 253 251 248 243 235 223 207 191 191 255 255 0 6 
40 224 128 4 22 104 224 129 8 38 168 224 130 12 54 232 224 131 16 70 40 225 132 20 86 104 225 133 24 102 168 225 134 28 254 
118 232 225 135 32 134 40 226 136 36 150 104 226 137 40 166 168 226 138 44 182 232 226 139 48 198 40 227 140 52 214 104 227 
141 56 230 168 227 142 60 246 232 227 143 64 6 41 228 144 68 22 105 228 145 72 38 41 68 0 76 50 169 228 93 77 70 41 165 147 
79 186 53 229 149 82 86 169 22 150 92 102 169 101 89 93 134 217 228 151 99 137 105 102 0 100 130 117 230 153 105 118 181 230 
154 109 106 245 230 155 113 94 53 231 156 117 86 117 39 158 121 70 181 39 159 125 62 245 39 160 129 46 53 40 161 133 38 117 
40 162 137 22 181 232 157 141 34 5 233 146 123 70 106 212 164 67 84 106 41 81 140 2 160 233 166 65 209 137 4 166 160 250 36 
106 18 157 150 154 211 169 163 166 170 170 77 112 50 225 234 171 52 197 186 4 169 180 194 106 171 18 184 230 90 43 155 78 
204 234 171 75 187 222 42 236 176 43 21 107 172 178 200 18 11 236 19 199 54 123 18 179 188 178 42 173 179 102 70 209 235 
181 42 157 41 128 20 209 114 43 210 179 80 132 43 46 72 254 228 66 107 237 185 39 9 144 110 176 235 178 91 146 187 77 10 
96 175 148 246 82 97 174 188 26 13 96 175 187 255 254 203 100 190 83 236 203 47 70 254 6 172 112 0 4 23 28 239 193 32 13 
144 176 0 19 7 60 64 21 6 67 92 17 1 18 119 236 177 199 24 63 172 113 71 4 112 252 241 201 33 83 59 50 71 28 155 252 177 
203 41 191 187 50 201 45 151 92 178 196 55 95 172 111 198 51 63 100 243 207 3 152 92 128 196 49 203 220 51 70 6 252 172 
180 208 87 240 124 244 66 37 23 80 192 210 4 76 77 64 211 34 63 77 145 212 83 39 173 244 212 5 96 173 178 214 19 121 109 
179 217 73 79 45 182 209 100 79 68 128 1 8 84 221 181 215 73 27 176 118 182 109 103 100 128 215 82 215 109 64 1 123 95 
109 133 211 121 23 148 116 220 8 0 30 184 223 119 139 89 56 210 123 71 254 247 228 138 55 30 230 227 23 237 221 183 226 
146 239 109 121 151 152 91 20 56 2 147 151 30 249 231 160 135 94 54 220 5 32 144 184 235 157 163 206 165 254 234 101 31 
192 122 235 156 123 46 59 150 180 75 116 128 237 174 191 254 58 220 88 108 219 187 66 191 239 13 60 220 176 31 80 60 225 
199 239 19 252 244 176 187 238 252 238 87 70 255 144 245 214 31 64 61 2 207 103 173 61 65 8 120 95 126 240 222 51 31 254 
216 227 15 244 253 251 235 179 221 190 251 239 83 31 63 222 243 39 244 253 239 10 240 127 253 224 208 203 31 61 92 167 0 
4 20 176 128 7 80 64 255 20 112 63 199 9 16 33 6 44 96 4 19 88 190 223 53 240 114 15 60 136 4 13 72 64 2 42 240 130 169 
203 96 65 10 184 0 14 74 240 128 224 195 222 148 68 104 16 3 150 48 130 10 84 64 9 23 0 194 217 177 144 124 27 12 158 4 
23 192 64 21 122 233 134 2 81 224 2 134 56 196 24 206 176 134 188 3 98 16 99 104 194 18 30 16 137 217 83 98 64 98 40 195 
42 10 113 136 80 92 161 20 1 226 68 30 90 145 138 89 252 225 22 251 65 68 43 22 145 135 52 244 97 148 198 248 143 51 202 
176 140 94 12 227 26 254 217 72 70 56 18 241 142 114 28 19 29 249 113 199 62 226 17 128 1 220 99 57 26 208 128 59 18 242 
144 11 112 128 26 231 40 200 124 16 145 1 144 100 128 3 32 57 73 69 2 82 124 141 124 135 3 38 73 201 74 74 210 1 15 88 36 
149 50 137 143 77 154 242 148 155 60 64 40 47 41 63 82 194 3 149 176 180 100 209 240 231 74 123 108 242 147 12 120 0 42 69 
137 166 90 222 99 147 15 120 192 39 65 25 76 89 238 12 147 190 92 135 41 131 169 203 83 174 114 150 14 76 38 61 64 9 74 73 
22 147 152 172 108 165 52 213 113 205 110 234 146 1 217 164 229 54 225 193 76 93 150 51 152 19 8 103 52 199 73 78 115 22 
211 157 198 4 151 241 216 201 205 115 6 19 2 204 84 39 6 233 249 142 115 226 83 151 16 112 0 4 244 25 66 126 182 163 156 
16 72 168 66 19 74 80 27 26 244 160 15 136 64 4 30 176 208 132 198 83 91 243 124 104 57 36 58 209 8 84 20 2 233 132 230 58 
53 154 142 132 122 20 164 14 152 64 74 5 254 218 208 40 146 116 29 30 229 232 74 39 0 210 129 30 19 153 47 5 7 71 79 90 81 
145 238 51 167 233 216 105 77 39 64 211 144 58 44 144 64 157 6 71 33 16 1 154 14 213 167 5 77 170 57 36 58 129 166 38 148 
166 49 189 41 251 164 234 13 161 14 181 166 90 213 38 87 185 81 213 170 126 181 168 97 21 231 88 197 33 129 182 186 181 173 
88 141 64 90 71 186 214 112 72 244 173 109 5 105 85 231 250 211 186 134 3 175 18 160 128 4 202 106 212 114 125 202 175 127 
5 172 4 154 42 209 163 34 21 177 203 192 171 96 39 48 88 185 202 51 163 144 205 70 91 5 251 214 178 58 118 171 153 189 6 5 
56 235 86 202 18 245 179 98 13 109 53 2 203 90 10 16 213 181 133 85 215 99 85 123 140 192 194 150 168 68 13 236 101 103 75 
219 98 140 118 176 19 184 237 104 119 139 211 222 70 99 180 194 69 174 4 42 128 81 204 26 119 26 130 133 109 5 130 139 220 
216 202 234 176 207 213 6 81 167 91 221 209 50 215 176 206 205 110 52 184 235 254 218 10 80 192 188 174 109 110 113 197 235 
12 242 154 23 189 231 133 2 189 120 203 94 96 84 224 190 200 125 111 124 159 48 223 245 214 119 25 239 157 192 125 223 123 
95 240 210 247 191 189 32 240 128 245 107 96 255 34 56 25 11 86 112 129 157 208 95 208 62 152 25 18 142 48 127 177 123 225 
105 12 248 2 17 158 240 117 195 219 97 0 135 248 190 32 134 23 137 75 156 12 16 127 24 197 34 94 214 129 89 156 11 20 187 
216 2 56 190 128 138 103 76 227 91 224 248 199 22 184 64 144 191 203 132 128 57 184 199 195 0 178 146 43 160 227 37 40 108 
0 22 70 178 49 46 32 228 31 83 249 202 69 30 88 133 185 68 52 41 75 195 202 87 14 50 149 179 60 48 40 7 0 202 18 99 146 153 
213 236 101 106 92 249 205 88 94 214 154 205 156 230 40 65 89 112 109 142 134 152 169 204 100 16 55 185 90 103 86 51 151 153 
132 231 60 63 3 206 112 94 194 154 7 29 104 61 26 250 208 136 126 115 181 210 188 232 38 45 26 205 143 134 198 149 51 16 105 
254 37 40 108 190 149 102 216 191 50 29 141 72 111 96 204 73 248 180 148 234 108 100 82 107 154 211 84 62 53 167 51 224 233 
79 247 119 205 1 115 53 164 47 112 106 94 199 249 8 4 176 245 191 232 172 229 134 233 122 25 178 142 245 5 56 189 1 90 31 65 
216 208 22 216 177 157 17 235 83 91 123 217 72 136 182 182 167 221 140 107 123 219 217 70 208 54 180 185 221 12 95 123 187 
217 207 22 183 176 201 205 12 13 52 187 218 178 78 183 186 63 205 110 102 240 122 3 248 54 247 6 194 93 177 121 127 171 222 
202 184 119 6 172 221 236 125 23 33 97 29 155 55 192 145 157 129 129 227 251 225 224 30 130 191 16 78 49 137 69 123 225 202 
128 248 195 31 126 240 147 81 250 204 29 19 181 177 49 110 12 124 59 124 227 29 247 184 202 39 254 111 146 31 67 227 27 55 
184 16 86 30 242 144 87 188 208 46 39 70 204 99 78 4 154 171 156 98 57 71 6 190 57 176 115 14 72 220 101 62 255 88 208 133 
190 113 162 227 123 8 38 187 25 210 87 142 243 165 254 11 163 232 27 32 186 16 74 38 128 150 225 44 104 30 183 153 213 75 
254 112 167 103 125 223 81 175 25 210 189 222 177 170 143 61 24 103 207 58 209 181 142 179 168 215 29 236 47 211 217 219 117 
46 247 161 107 125 105 95 79 187 203 56 182 247 98 112 224 240 114 159 59 208 164 110 179 192 7 173 101 133 55 124 226 15 
207 1 192 231 172 241 53 235 114 228 135 65 249 206 87 190 106 93 167 218 227 213 238 246 205 247 194 243 148 175 218 219 
168 198 120 198 155 158 24 168 23 128 213 66 175 122 214 63 254 245 176 247 124 218 0 87 251 168 177 190 244 184 223 69 7 
116 47 128 164 201 190 246 86 99 125 240 57 159 250 189 201 30 108 114 235 253 210 150 47 140 206 167 237 111 114 227 155 
213 120 175 122 234 87 159 242 92 235 155 234 185 230 251 237 3 223 251 185 232 64 7 254 38 53 185 133 31 108 237 31 255 249 
209 127 139 195 3 110 115 239 207 63 249 233 31 12 14 104 238 254 138 83 50 236 247 126 114 195 127 193 208 57 236 247 54 
187 167 127 97 99 254 128 191 192 126 16 232 55 165 147 127 14 8 12 145 195 57 1 248 127 85 51 128 21 232 11 8 56 129 117 
163 128 239 215 129 189 96 59 31 136 128 185 211 128 36 168 11 157 99 130 146 83 0 7 192 53 38 40 53 43 184 11 38 120 131 
45 168 56 49 200 57 53 200 130 229 99 0 201 3 132 65 56 131 49 168 59 61 120 11 205 243 59 74 8 132 202 3 131 64 200 131 71 
136 132 164 163 132 84 248 59 48 40 131 80 24 133 180 48 61 191 83 65 85 248 133 182 163 133 182 192 133 222 3 134 95 104 
132 96 240 1 98 24 9 100 232 133 94 88 133 78 40 6 31 0 2 107 248 8 9 144 0 245 131 62 102 56 6 106 88 135 142 112 135 8 0 
136 239 211 133 95 40 6 32 64 135 126 200 8 119 136 135 120 152 67 232 243 134 22 20 6 31 208 135 137 184 8 139 184 136 142 
152 135 41 244 5 147 136 136 149 168 8 12 16 136 139 216 65 154 136 0 29 224 1 96 0 2 148 248 137 136 208 0 8 192 0 10 128 
137 38 52 139 212 51 137 95 254 160 138 171 200 138 134 240 138 6 36 139 28 68 138 181 104 139 92 208 137 186 152 8 176 168 
0 176 152 0 10 164 140 40 116 66 27 212 1 147 40 140 89 16 141 197 152 8 84 84 64 161 136 0 174 56 139 40 228 58 209 72 141 
87 128 139 170 88 141 135 112 140 215 200 0 174 72 69 38 116 64 223 248 141 86 16 141 227 72 142 134 128 140 244 248 138 217 
232 138 176 248 139 40 20 141 28 48 137 253 152 139 79 48 135 2 41 143 134 16 73 176 136 142 200 216 0 9 25 65 218 168 64 28 
212 142 254 56 135 81 48 135 170 24 143 4 73 8 145 68 72 10 160 144 10 105 143 161 8 73 12 201 64 209 232 1 31 64 146 184 8 
144 72 80 145 20 233 137 23 41 8 156 4 73 27 169 145 200 8 146 31 105 142 61 52 146 37 9 145 73 0 2 30 112 136 157 104 145 
45 41 8 13 112 75 8 201 145 5 212 0 6 25 138 49 68 4 57 73 146 16 249 148 2 201 147 157 40 141 65 25 8 14 112 72 146 116 72 
88 25 73 246 24 65 9 80 4 254 57 9 149 98 233 1 61 89 145 85 73 8 149 180 73 67 169 0 155 52 147 73 153 148 71 224 147 98 57 
151 103 137 150 168 132 142 109 201 150 111 105 144 73 48 149 115 217 142 44 89 151 128 208 76 168 180 150 68 137 142 144 
148 0 161 200 4 42 57 151 64 41 152 128 64 77 132 9 75 144 244 0 132 4 151 77 112 146 79 9 153 134 192 76 146 121 151 87 
169 149 124 57 145 224 200 153 133 48 81 230 68 77 177 116 149 172 41 73 224 100 154 156 96 79 159 25 75 72 121 72 176 185 
9 18 101 79 158 73 155 166 116 155 184 25 81 186 89 78 203 116 149 194 116 81 190 57 9 59 149 155 255 36 156 170 121 75 207 
116 156 150 144 156 11 117 78 196 84 157 155 4 157 151 16 87 66 165 156 186 9 76 216 105 9 184 229 86 201 137 154 254 212 76 
207 249 157 145 16 158 120 53 158 194 73 81 231 137 158 143 128 91 185 5 88 59 21 81 228 73 81 240 57 9 19 96 1 219 53 93 111 
53 158 29 69 81 54 149 159 144 96 1 163 21 92 33 32 254 159 77 69 89 0 122 82 4 26 9 20 240 99 31 112 1 242 25 158 148 85 89 
59 245 160 5 138 99 20 192 1 34 96 160 20 208 1 252 169 160 17 176 88 25 170 161 141 80 101 65 166 2 17 74 1 25 240 1 21 154 
91 68 197 81 40 234 8 84 182 162 28 144 99 31 58 162 27 80 161 149 85 163 41 42 102 36 64 2 63 38 2 28 48 93 22 48 112 7 58 
159 214 5 164 134 112 163 33 176 2 25 128 99 30 64 164 21 96 160 31 138 92 20 122 90 78 170 8 87 198 1 44 16 2 56 198 1 43 
160 162 34 176 1 45 42 2 174 149 94 93 138 8 87 166 1 43 128 2 87 166 2 34 64 101 29 106 2 163 101 1 34 128 1 200 213 166 
137 176 108 23 112 2 44 208 107 34 80 166 84 6 167 55 122 1 106 218 162 126 122 8 128 42 2 44 96 2 84 214 1 44 208 1 87 118 
2 117 122 1 20 112 2 154 170 169 141 122 8 24 112 1 31 192 2 44 64 101 96 202 169 84 38 2 42 112 101 34 144 169 20 240 169 
134 176 1 238 254 70 170 19 122 1 42 192 2 28 96 170 44 80 171 96 90 101 127 6 171 129 160 1 23 160 1 183 42 169 24 80 2 44 
48 2 23 128 1 24 144 2 41 48 167 153 250 171 192 10 8 195 106 2 164 186 1 24 224 1 44 160 2 216 122 1 35 128 171 84 54 2 171 
250 107 211 250 7 26 128 1 144 186 171 195 74 171 161 58 170 146 122 1 148 10 2 55 90 174 129 128 111 218 202 2 40 192 172 
40 128 175 161 10 166 44 32 172 24 160 2 42 32 172 168 70 175 126 144 117 43 64 170 29 112 172 10 203 172 130 186 167 24 240 
173 181 42 173 6 171 7 135 119 171 145 170 1 247 106 172 223 202 2 161 74 169 114 90 176 21 187 7 135 103 173 44 176 2 135 
71 170 131 170 177 180 58 171 44 224 1 161 170 1 35 219 7 30 144 174 44 0 2 27 144 2 164 186 167 27 64 170 41 16 170 130 250 
174 50 59 179 123 48 137 42 139 2 28 96 178 3 139 1 130 138 171 24 48 170 184 74 176 68 171 7 147 136 177 149 10 2 42 251 1 
30 74 170 254 39 192 172 164 106 172 67 59 181 120 240 1 251 250 181 80 203 2 39 208 143 42 155 1 205 122 173 26 16 182 98 
107 7 32 208 180 219 218 1 58 75 170 30 192 1 119 107 2 27 144 174 34 32 172 112 27 183 115 32 2 200 170 178 115 171 178 105 
75 183 41 75 170 111 27 184 130 43 7 133 203 181 54 139 171 54 107 164 119 123 166 142 251 184 112 80 2 9 171 178 147 43 2 
103 171 2 28 64 183 28 167 185 116 96 181 104 107 181 42 240 1 86 11 186 158 123 120 166 75 7 101 75 170 42 64 183 44 32 2 
116 139 2 30 128 177 162 107 116 177 43 7 168 139 182 42 139 175 147 251 1 116 107 164 190 251 187 111 48 187 180 59 188 44 
16 185 104 27 185 171 155 188 202 235 6 206 187 173 195 123 2 168 91 188 168 88 189 111 112 189 215 203 188 38 48 187 40 64 
149 222 171 6 215 27 188 182 187 2 38 187 179 40 121 190 103 0 190 195 171 190 195 139 2 129 9 191 104 32 191 243 59 191 219 
43 2 248 219 6 250 11 190 168 139 2 254 251 254 191 214 27 192 242 91 2 6 12 7 8 156 190 38 176 192 113 208 192 136 11 193 
114 32 193 42 64 193 115 208 192 40 128 193 116 160 191 23 204 193 117 0 190 32 124 7 215 59 194 36 172 178 38 156 7 44 144 
194 44 220 194 46 252 194 48 28 195 50 60 195 52 92 195 54 124 195 56 156 195 58 188 195 60 220 195 62 252 195 64 28 196 66 
60 196 68 92 196 70 124 196 72 156 196 74 188 196 76 220 196 78 252 196 80 28 197 82 60 197 84 92 197 86 124 197 88 156 197 
90 188 197 92 220 197 94 252 197 96 28 198 98 60 198 100 92 198 102 124 198 104 156 198 106 188 198 108 220 198 110 252 198 
112 28 199 114 60 199 116 92 199 118 124 199 120 156 199 122 188 199 124 220 199 126 252 199 128 28 200 130 60 200 132 92 
200 134 124 200 136 156 200 138 188 200 140 220 200 142 252 200 144 28 201 146 60 201 148 92 201 150 124 201 152 156 201 
154 188 201 156 220 201 158 252 201 160 28 202 162 60 202 164 92 202 166 124 202 168 156 202 170 188 202 172 220 202 174 
55 252 202 176 28 203 178 60 203 180 92 203 182 124 203 184 156 203 186 188 203 188 220 203 190 252 203 192 28 204 194 60 
204 196 92 204 198 124 204 200 156 204 202 188 204 204 220 204 206 252 204 208 60 70 65 0 0 59)
"Raw data of Linearity Co. Ltd. logo")

(defparameter *call-num* 30 "Max. number of passengers in system")
(defparameter *r* 10 "Distance between call indications")
(defparameter *d* 5 "Size of elevator")
(defparameter dd 5 "Size of passenger")
(defparameter p 5 "Frame width of elevator")   
(defparameter y-offs nil "Start floor")
(defparameter left 400 "Width of passenger pane")
(defparameter h 600 "Height of GUI")
(defparameter w 500 "Width of GUI")
(defparameter col #("salmon" "salmon" "gold" "burlywood" "pale green" "SlateGray1" "turquoise1" "royalblue1" "MediumPurple1" ) "Elevator colors")   
(defparameter *bg-col* "steel blue" "GUI backgrounds") 
(defparameter *line-col* "powder blue" "GUI foregrounds")
(defparameter from-flr nil "Origin of generated passenger")
(defparameter to-flr nil "Destination of generated passenger")  
(defparameter ncall 0 "Current number of passengers") 
(defparameter b2c nil "Indicator of simulation on-going")
(defparameter *finished* nil "Serviced passengers")
(defparameter *recording* nil "Enable dumping of events")
(defparameter *generating* nil "Continuous generation of passengers")
(defparameter *pending* 0 "Number of pending passengers in system")
(defparameter *pending-limit* 0 "Limit on number of pending passengers in system")
(defparameter *bldg* nil "The building with shafts, passengers etc.")
(defparameter *after* nil "Tag of scheduled LTK timer event")
(defparameter p0 nil "Generated passenger")
(defparameter *passenger-plane* nil "Traffic object")
(defparameter *delay* 100 "Delay time between event steps")
(defparameter *img* nil "LOGO image")
(defparameter *ns* nil "Shafts")
(defparameter *nc* nil "Elevators")
(defparameter *top* nil "Floors")
(defparameter *start* nil "Button for initializing simulator")
(defparameter *top+* nil "Total floors including garage")
(defparameter *call-column* 2 "Position of passenger panel")
(defparameter *floor-column* 3 "Position of floor numbers")
(defparameter *floor-plane* nil "Floor numbers")
(defparameter *shaft-column* 4  "Position of elevator panel")
(defparameter *button-column* 1 "Position of buttons")
(defparameter *logo-file*
  #+os-unix "/tmp/logo.gif"
  #+linux "/tmp/logo.gif"
  #+win32 "logo.gif"
 "Path of the logo file, first generated from raw data, then read back into Ltk"
)


(defmacro defcl(name &rest slots)
  "Simplify DEFCLASS by automated accessor etc. names"
  (let ((l (mapcar
	    (lambda(x)(list x :accessor x
			    :initform nil
			    :initarg (intern (symbol-name x) (symbol-package :X))))
	    slots)))
  `(defclass ,name () ,l))
)

(defmacro defpr(name &rest excl)
  "Print an object with the value of its slots"
#+ccl
  `(defmethod print-object ((obj ,name) stream)
     (let ((slots (mapcar #'slot-definition-name (class-direct-slots (class-of obj))))
           (values nil))
       (dolist (e ',excl) (setf slots (remove e slots)))
       (setf values (loop for s in slots collect (list s (eval (list s obj)))))
    (format stream "~A: ~A" ',name values)))
#+sbcl
  `(defmethod print-object ((obj ,name) stream)
     (let ((slots (mapcar #'sb-mop:slot-definition-name (sb-mop:class-direct-slots (class-of obj))))
           (values nil))
       (dolist (e ',excl) (setf slots (remove e slots)))
       (setf values (loop for s in slots collect (list s (eval (list s obj)))))
    (format stream "~A: ~A" ',name values)))

)


; Class for elevators
(defcl cage pos dir home waiting boarded zone shaft yield ahead behind blocker nc id state view)
(defpr cage shaft behind ahead blocker)

; Class for shafts
(defcl shaft cages dir nc cpos top id y view up-dir down-dir)

; Class for passengers
(defcl passg from to dir id sid view)
(defpr passg)

; Class for traffic (passenger generator)
(defcl traff top rate view)

; Class for building (top level object)
(defcl bldg ns top shafts view)
(defpr bldg shafts)

(defun make-cage(i z s nc)
  (let* ((c (make-instance 'cage :pos i :dir nil :home i :waiting nil :boarded nil :zone z :shaft s :nc nc :state 'idle)))
    (setf (id c) (- i))
    (push c (cages s))
    c))

(defun range(start len)
  (loop for i from start for n below len collecting i))

(defun range2(start end)
  (loop for i from start below end collecting i))

(defun zones(n i) 
  (if (= i 0) 0
      (sqrt (+ (/ 1 n) (expt (zones n (1- i)) 2)))))

(defun zones2(n i l)
  (floor (* l (zones n i))))

(defun make-shaft(nc top id &optional (lin nil))
  (let* ((s (make-instance 'shaft :dir 'up :nc nc :top top :cpos (make-array (1+ nc)) :id id))
         (l (floor (/ top nc)))
         (b nil)
         (c nil))
    (dotimes (i nc)
      (if lin
          (setf c (make-cage (- i nc) (range (* i l) l) s nc))
          (setf c (make-cage (- i nc) (range2 (zones2 nc i top) (zones2 nc (1+ i) top)) s nc)))
      (when b (setf (ahead b) c))
      (setf (behind c) b)
      (setf b c))
    s))

(defun make-bldg(ns nc top)
  (let* ((b (make-instance 'bldg :top top :ns ns)))
    (dotimes (i ns)
      (push (make-shaft nc top (1+ i)) (shafts b)))
    b))

(defun make-traff(rate top)
  (make-instance 'traff :top top :rate rate))

(defun generate (top &optional (rate 0.5))
  (when (< (random 1.0) rate)
    (let* ((from (random top))
           (to (mod (+ (random (1- top)) 1 from top) top))
           (psg (make-instance 'passg :from from :to to :dir (if (< from to) 'up 'down))))
      psg)))

(defmethod find-zone ((s shaft) fl)
  (with-slots (cages) s
    (dolist (c cages)
      (when (find fl (zone c))
        (return c)))))

(defmethod assign ((s shaft) (p passg))
  (incf *pending*)
    (with-slots (from to) p
      (let ((c (find-zone s (max from to))))
        (push p (waiting c))
        (setf (id p) (id c))
        (setf (sid p) (id s))
        (disp-call p)
        c)))
  

(defun record(id pos)
  (when *recording*
    (format t "~A: ~A~%" id pos)))

(defmethod update((c cage))
  (with-slots (state yield pos) c
    (set-dir c)
    (setf state
          (case state
            (idle (if (no-calls c) 'idle 'wake))
            (wake (if (stop-here c) 'open 'route))
            (open  (when (and yield (= pos yield)) (setf yield nil)) 'leave)
            (leave (leave c) 'board)
            (board (board c) 'close)
            (close (if (no-calls c) 'idle 'route))
            (route (if (blocked c) 'route 'run))
            (run (if (stop-here c) 'open (if (blocked c) 'route (progn (advance c) 'run))))))))

(defmethod advance((c cage))
  (with-slots (pos dir ahead behind id nc yield state shaft) c
    (case dir
      (up (if (or (null ahead) (< pos (1- (pos ahead)))) (incf pos) (error "crash ~A into ~A" c ahead)))
      (down (if (or (null behind) (> pos (1+ (pos behind)))) (decf pos) (error "crash ~A into ~A" c behind))))
    (disp shaft id pos)
    (record id pos)))

(defmethod waiting-above((c cage))
  (find (pos c) (waiting c) :test (lambda(x y) (< x (from y)))))

(defmethod waiting-below((c cage))
  (find (pos c) (waiting c) :test (lambda(x y) (> x (from y)))))

(defmethod waiting-here((c cage))
  (find c (waiting c) :test (lambda(x y)
                          (and (= (pos x) (from y)) (eql (dir x) (dir y))))))

(defmethod going-above((c cage))
  (find (pos c) (boarded c) :test (lambda(x y) (< x (to y)))))

(defmethod going-below((c cage))
  (find (pos c) (boarded c) :test (lambda(x y) (> x (to y)))))

(defmethod going-here((c cage))
  (find c (boarded c) :test (lambda(x y) (= (pos x) (to y)))))

(defmethod closest-stop((c cage))
  (with-slots (pos dir waiting boarded yield) c
    (if dir
        (let* ((test-sort (if (eql dir 'up) #'< #'>))
               (test-find (if (eql dir 'up) #'<= #'>=))
               (test-reverse (if (eql dir 'up) #'> #'<))
               (test-wait (if (eql dir 'up) #'>= #'<=))
               (going-closest 
                (find pos (sort (mapcar 'to boarded) test-sort)
                      :test test-find))
               (waiting-closest
                (first (sort  (remove nil (map 'list (lambda(x)(when (and (eq (dir x) dir)(funcall test-wait (from x) pos)) (from x))) waiting)) test-sort)))
               (waiting-reverse
                (first (sort  (remove nil (map 'list (lambda(x)(when (and (not (eql (dir x) dir))(funcall test-wait (from x) pos)) (from x))) waiting)) test-reverse)))
               (any-stop (remove nil (list going-closest waiting-closest yield))))
          (if any-stop (apply (if (eql dir 'up) #'min #'max) any-stop) waiting-reverse))
        nil)))
          
(defmethod leave((c cage))
  (with-slots (boarded yield behind ahead dir pos id) c
    ;; remove passengers going here
    (loop 
      (unless
          (let ((p (going-here c)))
            (when p
              (setf boarded (remove p boarded))
              (disp-leave p)
              (push p *finished*)
              (decf *pending*)
              (record id p))
            p)
        (return)))))

(defmethod board((c cage))
  (with-slots (waiting boarded yield behind ahead dir pos id) c
    ;; add passengers waiting here
    (loop 
      (unless
          (let ((p (waiting-here c)))
            (when p
              (setf waiting (remove p waiting))
              (push p boarded)
              (disp-board p)
              (record id p))
            p) 
        (return)))))

(defmethod no-calls((c cage))
  "T if no calls for the cage with the current direction"
  (with-slots (pos dir waiting boarded yield) c
    (and (null yield) 
         (case dir
           (up (and (not (waiting-above c))
                    (not (going-above c))
                    (not (waiting-here c))))
           (down (and (not (waiting-below c))
                      (not (going-below c))
                      (not (waiting-here c))))
           (otherwise t)))))

(defmethod stop-here((c cage))
  "There is a reason to stop: call here, directed here by yield, or no calls"
  (with-slots (pos yield) c
      (or 
       (no-calls c)
       (going-here c)
       (waiting-here c)
       (and yield (= yield pos)))))

(defmethod blocked((c cage))
  "Cage is blocked by other cage ahead, it will be asked to yield"
  (with-slots (pos dir waiting boarded ahead behind blocker) c
    (let* ((x (closest-stop c))
           (y (case dir
                (up (1+ x))
                (down (1- x))))
           (b (case dir
                (up (if (and x ahead (<= (pos ahead) x)) ahead nil))
                (down (if (and x behind (>= (pos behind) x)) behind nil)))))
      (when b 
        (setf (yield b) y)
        (blocked b)
        (set-dir b))
      (setf blocker b))))

(defmethod set-dir((c cage))
  "Set the direction to shaft direction if there are passengers, or NIL"
  (with-slots (pos dir waiting boarded shaft yield) c
    (let ((new-dir
           (case (dir shaft)
             (up (if (or (and yield (< pos yield))
                          (find pos boarded :test (lambda(x y) (< x (to y))))
                          (find pos waiting :test (lambda(x y) (or (< x (from y))
                                                                   (and (eql (dir y) 'up) (= x (from y)))))))
                      'up nil))
             (down (if (or (and yield (> pos yield))
                            (find pos boarded :test (lambda(x y) (> x (to y))))
                            (find pos waiting :test (lambda(x y) (or (> x (from y))
                                                                     (and (eql (dir y) 'down) (= x (from y)))))))
                      'down nil)))))
      (setf dir new-dir))))

(defmethod scan((s shaft))
  "Execute events for cages in shaft and return T if all are idling"
  (let ((res t))
    (dolist (c (cages s))
      (unless (eql (update c) 'idle) (setf res nil)))
    res))

(defmethod turn ((s shaft) d)
  "Turn around the shaft direction and show in GUI"
  (with-slots (cages dir view up-dir down-dir) s
    (setf dir d)
    (case d
      (up (ltk:itemconfigure view up-dir :fill "white")
          (ltk:itemconfigure view down-dir :fill *bg-col*))
      (down (ltk:itemconfigure view down-dir :fill "white")
          (ltk:itemconfigure view up-dir :fill *bg-col*)))
    (dolist (c cages)
      (set-dir c))
))

(defmethod over((s shaft))
  "T if no passengers for any of the cages"
  (let ((x t))
    (dolist (c (cages s))
      (when (waiting c) (setf x nil))
      (when (boarded c) (setf x nil)))
    x))

(defun run-shaft(s)
  "Try running cages, return NIL if all idle, T if things are happening"
  (block nil
      (when (over s) (return nil))
      (when (scan s)
        (turn s (if (eql (dir s) 'up) 'down 'up)))
    t))

(defun run-sim(s n)
  "Run the shaft a given number of time steps"
  (dotimes (i n)
    (run-shaft s)))

(defun home-all(s)
  "Remove all passengers, remove cages into garage, make them idle"
  (dolist (c (cages s))
    (setf (pos c) (home c) (dir c) (dir (shaft c)) (state c) 'idle)
    (dolist (p (waiting c))
      (push p *finished*))
    (setf (waiting c) nil)
    (dolist (p (boarded c))
      (push p *finished*))
    (setf (boarded c) nil)
    (record (id c) (pos c))
    (disp s (id c) (pos c)))
)

(defun home-all-shafts()
  "Home all the shafts in the building"
  (dolist (s (shafts *bldg*))
    (home-all s))
  (dolist (p *finished*)
    (with-slots (view) p
      (ltk:itemconfigure (view *passenger-plane*) (nth 2 view) :fill *bg-col*)
      (ltk:itemconfigure (view *passenger-plane*) (nth 1 view) :fill *bg-col*)
      (ltk:itemconfigure (view *passenger-plane*) (nth 0 view) :outline *bg-col*)
      (ltk:itemconfigure (view *passenger-plane*) (nth 0 view) :fill *bg-col*)))
  (setq *finished* nil)
  (setq ncall 0)
  (ltk:create-image (view *passenger-plane*) -200 0 :image *img*)
)



(defun no-psg()
  "T if no passengers in simulation"
  (let ((all t))
    (dolist (s (shafts *bldg*))
      (unless (over s) (setq all nil)))
    all))

(defun go-sim()
  "Run simulation for one time step, schedule next step after a delay"
  (when (and *generating* (< *pending* *pending-limit*))
    (assign (random-shaft) (generate (top *bldg*) 1)))
  (dolist (s (shafts *bldg*))
    (run-shaft s))
    (if (no-psg)
        (ltk:configure b2c :background "white")
        (setq *after*
              (ltk:after *delay* #'go-sim))))


(defmethod disp((s shaft) id pos)
  "Show the current positions of cages in the shaft as colored squares"
  (with-slots (cpos y) s
  (ltk:itemconfigure (view s) (aref y (+ y-offs (aref cpos id))) :fill *bg-col*)
  (ltk:itemconfigure (view s) (aref y (+ y-offs pos)) :fill (aref col id))
  (setf (aref cpos id) pos)))

(defmethod disp-call((p passg))
  "Show the passenger origin and destination with the color of its cage"
  (with-slots (from to view id sid dir) p
    (if (>= ncall (1- *call-num*))
      (ltk::move-all (view *passenger-plane*)  (- *r*) 0)
      (incf ncall))
    (let* ((x0 (* ncall *r*)) 
           (y0 (* (- *top+* (+ from *nc* 0.5))  *d*))
           (x1 x0) 
           (y1 (* (- *top+* (+ to *nc* 0.5))  *d*))
           (begin (ltk:create-oval (view *passenger-plane*) (- x0 dd)(- y0 dd)(+ x0 dd)(+ y0 dd)))
           (end (ltk:create-line* (view *passenger-plane*) x0 y0 x1 y1))
           (tx (ltk:create-text (view *passenger-plane*) 
                                x0  (+ y0 (case dir (up 10)(down -20))) 
                                   (format nil "~A" sid))))
      (ltk:itemconfigure (view *passenger-plane*) tx :fill "powder blue")
      (ltk:itemconfigure (view *passenger-plane*) begin :width 3)
      (ltk:itemconfigure (view *passenger-plane*) begin :outline (aref col id))
      (ltk:itemconfigure (view *passenger-plane*) begin :fill (aref col id))
      (ltk:itemconfigure (view *passenger-plane*) end :fill (aref col id))
      (ltk:itemconfigure (view *passenger-plane*) end :width 3)
      (setf view (list begin end tx)))))

(defmethod disp-board((p passg))
  "Handle display update for boarded passenger"
   (with-slots (view) p
     (ltk:itemconfigure (view *passenger-plane*) (nth 0 view) :outline "powder blue")))

(defmethod disp-leave((p passg))
  "Handle display update for served passenger"
   (with-slots (view) p
     (ltk:itemconfigure (view *passenger-plane*) (nth 1 view) :fill "powder blue")))
 
  
(defun main(&optional arg)
  "Main entry, called from system"
(declare (ignore arg)) 
(block main
(ignore-errors  ;; comment out this if debugging
 ;; Create the "logo.gif" file in /tmp (Unix) or in current directory (Windows)
    (with-open-file (ll *logo-file* :direction :output 
                        :if-exists :supersede :if-does-not-exist :create 
                        :element-type '(unsigned-byte 8)) (write-sequence logo0 ll))
    ;(ql:quickload "ltk")
    (ltk:start-wish)
    (ltk:wm-title ltk::*tk* "LINEARITY MULTI-CAR SIMULATOR")

;; Initial screen: numerical entry fields for setup values
(let* ((fm (make-instance 'ltk:frame :master nil :width w))
       (be1 (make-instance 'ltk:entry :master fm :text "2" :width 4))
       (be2 (make-instance 'ltk:entry :master fm :text "3" :width 4))
       (be3 (make-instance 'ltk:entry :master fm :text "12" :width 4))
       ;; Main program will be started from this button:
       (bb1 (make-instance 'ltk:button :master fm :text "START" 
              :command (lambda () 
                         (setq *ns* (parse-integer (ltk:text be1)))
                         (setq *nc* (parse-integer (ltk:text be2)))
                         (setq *top* (parse-integer (ltk:text be3)))
                         (start)))))
  (ltk:configure ltk:*tk* :background *bg-col*)
  (ltk:configure fm :borderwidth 0)
  (ltk:grid fm 8 0 :columnspan 8)
  (let ((tx (make-instance 'ltk:message :master fm :text "SHAFTS:" :width 80)))
    (ltk:configure tx :background *bg-col* :foreground "yellow")
    (ltk:grid tx 0 0))
  (ltk:configure be1 :foreground *bg-col*)
  (ltk:grid be1 0 1)
  (let ((tx (make-instance 'ltk:message :master fm :text "CAGES:" :width 80)))
    (ltk:configure tx :background *bg-col* :foreground "yellow")
    (ltk:grid tx 0 2))
  (ltk:configure be2 :foreground *bg-col*)
  (ltk:grid be2 0 3)
  (let ((tx (make-instance 'ltk:message :master fm :text "FLOORS:" :width 80)))
    (ltk:configure tx :background *bg-col* :foreground "yellow")
    (ltk:grid tx 0 4))
  (ltk:configure be3 :foreground *bg-col*)
  (ltk:grid be3 0 5)
  (ltk:grid bb1 0 6)
  (setq *start* bb1)
  (ltk:mainloop)
)))
)

(defun start()
 (let* ((b0 nil)(b0c nil)(b1 nil)(b2 nil)(b3 nil)(b4 nil)) 
  (setq *passenger-plane* (make-traff 1 *top*))
  (ltk:configure *start* :command (lambda()))
  (setf (view *passenger-plane*) (make-instance 'ltk::canvas :width left :height h))
  (ltk:configure (view *passenger-plane*) :background *bg-col*)
  (ltk:configure (view *passenger-plane*) :relief "sunken")
  (ltk:configure (view *passenger-plane*) :borderwidth 3)
  (setq *floor-plane* (make-instance 'ltk::canvas :width 30 :height h))
   (ltk:configure *floor-plane* :background *bg-col*)
  (ltk:configure *floor-plane* :relief "sunken")
  (ltk:configure *floor-plane* :borderwidth 3)
 (setq *img* (ltk:make-image))
  (ltk:image-load *img* *logo-file*)
  (ltk:create-image (view *passenger-plane*) -200 0 :image *img*)
  (ltk:grid (view *passenger-plane*) 0 *call-column* :rowspan 5)
  (ltk:grid *floor-plane* 0 *floor-column*  :rowspan 5)
  (setq *pending-limit* (* *ns* *nc*))
  
  ;(setq *ns* 3 *nc* 4 *top* 12 *top+* (+ *nc* *top* 1) d (floor (/ h *top+*)) p 4)
  (setq *top+* (+ *nc* *top* 1))
  (setq *d* (floor (/ h *top+*)) p 6)
  ;(setq y (make-array *top+*))
;  (setq *call-pos* (make-array (list *top+* *call-num*)))
  (setq *r* (floor (/ left *call-num*)))
  (setq y-offs *nc*)
  (setq *bldg* (make-bldg *ns* *nc* *top*))
  (defun get-floor(yy)
    (min (- *top+* *nc* 1) (max 0 (floor (- *top+* *nc* (/ yy *d*))))))
  
  
  (dolist (s (shafts *bldg*))
    ;; Create canvas for shaft
    (with-slots (view y up-dir down-dir) s
      (setf y (make-array *top+*))
      (setf view (make-instance 'ltk::canvas :width *d* :height h))
      (ltk:configure view :background *bg-col*)
      (ltk:configure view :relief "sunken")
      (ltk:configure view :borderwidth 3)
      ;(let ((bd (ltk:create-rectangle view 0 0 d h)))
      ;  (ltk:itemconfigure view bd :fill *bg-col*))
      (setf up-dir (ltk:create-text view (/ *d* 2) (/ *d* 4) "^"))
      (setf down-dir (ltk:create-text view (/ *d* 2) (/ *d* 2) "v"))
      (ltk:itemconfigure view up-dir :fill "white")
      (ltk:itemconfigure view down-dir :fill *bg-col*)
      ;; Create "Floor" rectangles, color will show presence of cage
      (dotimes (i *top+*) 
        (when (> i 0)
          (setf (aref y (- *top+* i 1))
                (ltk:create-rectangle view p (+ (* i *d*) p) (- *d* p) (- (* (1+ i) *d*) p)))
          (ltk:itemconfigure view (aref y (- *top+* i 1)) :outline "powder blue")
          (ltk:itemconfigure view (aref y (- *top+* i 1)) :fill *bg-col*)))
      ;; Remember the positions of each car, this will be updated when they move
      (loop for i from 0 below *nc* for c in (cages s) do 
        (setf (aref (cpos s) i) (pos c)))
      (ltk:grid view 0 (+ *shaft-column* (id s)) :rowspan 5)
      (home-all s)))
  
  (dotimes (i (top *bldg*)) 
    (let ((tx (ltk:create-text *floor-plane* 5 (+ (* (- *top+* i *nc* 1) *d*) p) (format nil "~A" i))))
      (ltk:itemconfigure *floor-plane* tx :fill "powder blue")))
    
  (home-all-shafts)
  
  (defun random-shaft()
    (let* ((n (random (ns *bldg*)))
           (s (nth n (shafts *bldg*))))
      s))
  
  (setq b0 (make-instance 'ltk::button :master nil :text "CALLS"
             :command (lambda () 
                        (setq *generating* (not *generating*))
                        (if *generating*
                            (ltk:configure b0c :background "red")
                            (ltk:configure b0c :background "white")
                       ))))
  
  (ltk:grid b0 0 *button-column*)
  (setq b0c (make-instance 'ltk::canvas :master nil :width 8 :height 8))
  (ltk:configure b0c :background "white")
  (ltk:grid b0c 0 0)

  (setq b1 (make-instance 'ltk::button :master nil :text "STEP"
             :command (lambda () 
                        (dolist (s (shafts *bldg*))
                          (run-shaft s)))))
  
  (ltk:grid b1 1 *button-column*)

  (setq b2c (make-instance 'ltk::canvas :master nil :width 8 :height 8))
  (ltk:configure b2c :background "white")
  (ltk:grid b2c 2 0)
  (setq b2 (make-instance 'ltk::button :master nil :text "GO"
             :command (lambda () 
                        (if *after* 
                            (progn 
                              (ltk:after-cancel *after*)
                              (ltk:configure b2c :background "white")
                              (setq *after* nil)
                              )
                            (progn
                              (go-sim)
                              (ltk:configure b2c :background "red")
                              ))
                        )))
  (ltk:grid b2 2 *button-column*)
  (setq b3 (make-instance 'ltk::button :master nil :text "RESET"
             :command (lambda () 
                        (home-all-shafts))))
  (ltk:grid b3 3 *button-column*)
  (setq b4 (make-instance 'ltk::button :master nil :text "EXIT"
             :command (lambda () 
                        (setf ltk::*exit-mainloop* t))))
  (ltk:grid b4 4 *button-column*)
  (setq *delay* 500)
  
  (ltk:bind (view *passenger-plane*) "<ButtonPress-1>"
            (lambda (evt)
              (setq from-flr (get-floor (ltk:event-y evt)))
              ))
  
  (ltk:bind (view *passenger-plane*) "<ButtonRelease-1>" 
            (lambda (evt)
              (setq to-flr (get-floor (ltk:event-y evt)))
              (when 
                  (and 
                   (not (= to-flr from-flr)) 
                   (>= from-flr 0)(< from-flr (top *bldg*))
                   (>= to-flr 0)(< to-flr (top *bldg*)))
                (setq p0 (make-instance 'passg :from from-flr :to to-flr :dir (if (< from-flr to-flr) 'up 'down)))
                (assign (random-shaft) p0))
              ))
  
  (dolist (s (shafts *bldg*))
    (ltk:bind (view s) "<ButtonPress-1>"
              (lambda (evt)
                (setq from-flr (get-floor (ltk:event-y evt)))
                ))
    
    (ltk:bind (view s) "<ButtonRelease-1>" 
              (lambda (evt)
                (setq to-flr (get-floor (ltk:event-y evt)))
                (when 
                    (and 
                     (not (= to-flr from-flr)) 
                     (>= from-flr 0)(< from-flr (top s))
                     (>= to-flr 0)(< to-flr (top s)))
                  (setq p0 (make-instance 'passg :from from-flr :to to-flr :dir (if (< from-flr to-flr) 'up 'down)))
                  (assign s p0))
                )))
))
